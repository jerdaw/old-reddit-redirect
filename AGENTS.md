# AGENTS.md

AI coding agent instructions for this repository. This file provides guidance for Claude Code, Cursor, Copilot, Aider, and other AI development tools.

---

## Quick Reference

| Command            | Purpose                    |
| ------------------ | -------------------------- |
| `npm install`      | Install dependencies       |
| `npm test`         | Run test suite (811 tests) |
| `npm run dev`      | Live-reload dev server     |
| `npm run lint:fix` | Fix linting issues         |
| `npm run format`   | Format with Prettier       |
| `make`             | Build extension zip        |

---

## Project Overview

**Type:** Browser extension (Chrome/Firefox)
**Purpose:** Redirects all Reddit URLs to old.reddit.com
**API:** Manifest V3 with `declarativeNetRequest`
**Tests:** Vitest (811 tests across 24 suites)

---

## Critical Rules

### Git Commit Policy

**IMPORTANT**: Only humans should be credited as authors on commits. Never include AI attribution (e.g., "Co-Authored-By: Claude", "Generated by Copilot") in commit messages or code comments.

### Code Style

- **ESLint**: Strict mode, no-var, prefer-const
- **Prettier**: 2-space indent, double quotes, trailing commas (ES5)
- **Pattern**: All code wrapped in IIFE to avoid global scope pollution
- **Pre-commit**: Run `npm run lint:fix && npm run format` before committing

### Security

- Avoid introducing OWASP top 10 vulnerabilities (XSS, injection, etc.)
- Never commit sensitive data or credentials
- Validate all user input at system boundaries

---

## Architecture

### Core Files

| File                     | Purpose                                             |
| ------------------------ | --------------------------------------------------- |
| `manifest.json`          | Extension manifest (V3)                             |
| `rules.json`             | Declarative net request redirect rules              |
| `background.js`          | Service worker (toggle, stats, context menus)       |
| `storage.js`             | Centralized storage abstraction with sync           |
| `logger.js`              | Logging utility with configurable levels            |
| `content-script.js`      | Injected into old.reddit.com (filtering, dark mode) |
| `styles.css`             | Content script CSS (themes, nag blocking)           |
| `popup.html/js/css`      | Extension popup UI                                  |
| `options.html/js/css`    | Full options page                                   |
| `onboarding.html/js/css` | First-run experience                                |

### Redirect Rule Priority System

Rules in `rules.json` use priority ordering (higher = processed first):

| Priority | Purpose                                        | Rule IDs |
| -------- | ---------------------------------------------- | -------- |
| 3        | Allowlist (paths that must stay on new Reddit) | 1-5      |
| 2        | Special redirects (gallery, videos, headers)   | 10-12    |
| 1        | Domain redirects (main redirect logic)         | 20-22    |

**Allowlisted paths** (don't exist on old Reddit):

- `/media`, `/mod`, `/poll`, `/settings`, `/topics`, `/vault`, `/avatar`, `/talk`, `/coins`, `/premium`, `/predictions`, `/rpan`
- Subdomains: `chat.reddit.com`, `mod.reddit.com`, `sh.reddit.com`

### Rule Types

- `redirect`: Transform URL (host, path, or regex substitution)
- `allow`: Skip redirect rules (for allowlisting)
- `modifyHeaders`: Modify request headers

---

## Testing

### Test Suites

| File                                 | Tests | Coverage                        |
| ------------------------------------ | ----- | ------------------------------- |
| `rules.test.js`                      | 11    | Rule structure, manifest config |
| `patterns.test.js`                   | 21    | URL pattern matching            |
| `stats.test.js`                      | 19    | Statistics tracking             |
| `storage.test.js`                    | 21    | Storage schema, sync            |
| `frontends.test.js`                  | 26    | Alternative frontend configs    |
| `suggestions.test.js`                | 22    | Subreddit suggestions           |
| `comments.test.js`                   | 77    | Comment enhancements            |
| `sort-preferences.test.js`           | 23    | Sort order memory               |
| `user-tags.test.js`                  | 25    | User tagging                    |
| `user-muting.test.js`                | 34    | User muting                     |
| `advanced-keyword-filtering.test.js` | 46    | Keyword/regex filtering         |
| `scroll-positions.test.js`           | 25    | Scroll position memory          |
| `privacy.test.js`                    | 25    | Tracking protection             |
| `advanced-blocking.test.js`          | 23    | Content blocking                |
| `keyboard-shortcuts.test.js`         | 92    | Keyboard shortcuts              |
| `feed-enhancements.test.js`          | 33    | Feed modes, custom CSS          |
| `layout-presets.test.js`             | 42    | Layout preset management        |
| `privacy-enhancements.test.js`       | 39    | Privacy settings                |
| `performance.test.js`                | 28    | Performance benchmarks          |
| `accessibility.test.js`              | 38    | Accessibility features          |
| `navigation-enhancements.test.js`    | 28    | Navigation features             |
| `reading-history.test.js`            | 28    | Reading history                 |
| `nsfw-controls.test.js`              | 39    | NSFW content controls           |
| `comment-minimap.test.js`            | 46    | Comment thread minimap          |

### Running Tests

```bash
npm test              # Run all tests
npm run test:watch    # Watch mode
```

### Manual Testing Checklist

1. `https://reddit.com` → redirects to `old.reddit.com`
2. `https://reddit.com/settings` → stays on new Reddit (allowlisted)
3. `https://reddit.com/gallery/abc123` → redirects to `old.reddit.com/comments/abc123`
4. Alt+Shift+R → toggles redirect on/off
5. Extension icon badge shows "OFF" when disabled

---

## Feature Summary by Version

### v6.0.0 - Dark Mode & Content Filtering

- Auto/Light/Dark/OLED themes
- Nag blocking (login prompts, app prompts)
- Bot auto-collapse (13 bots including AutoModerator)
- Subreddit/keyword/domain muting

### v7.x - Comment Enhancements

- Color-coded depth indicators
- Navigation buttons (Shift+J/K)
- Inline image expansion

### v8.x-v10.x - User Experience

- Sort order memory per subreddit
- User tagging (500 tags, 12 colors)
- Scroll position memory (24-hour retention)

### v11.x - Feed & Privacy

- Compact/text-only modes
- Tracking parameter removal (32 params)
- Referrer control policies
- AI overview blocking

### v12.x - Advanced Filtering

- User muting (500 users)
- Regex keyword support
- Flair/score filtering
- Customizable keyboard shortcuts with chord support

### v13.x-v19.x - Content Controls & Navigation

- Reading history tracking (optional, local-only)
- Layout presets (save/restore UI configurations)
- Accessibility enhancements (focus indicators, ARIA)
- Navigation enhancements (permalink highlighting, parent navigation)
- NSFW content controls (blur, hide, per-subreddit allowlist)
- Comment thread minimap (visual navigation)

---

## Adding Features

### New Redirect Rule

Add to `rules.json`:

```json
{
  "id": 23,
  "priority": 1,
  "condition": {
    "urlFilter": "||example.reddit.com/*",
    "resourceTypes": ["main_frame"]
  },
  "action": {
    "type": "redirect",
    "redirect": {
      "transform": { "host": "old.reddit.com" }
    }
  }
}
```

### New Allowlist Path

Add priority 3 rule:

```json
{
  "id": 6,
  "priority": 3,
  "action": { "type": "allow" },
  "condition": {
    "urlFilter": "||reddit.com/newfeature/*",
    "resourceTypes": ["main_frame"]
  }
}
```

**Note:** Regex capture groups use `\\1`, `\\2`, etc.

---

## Debugging

### Chrome

1. `chrome://extensions/` → Enable Developer mode
2. Click "Inspect views: service worker"
3. Check Console for errors

### Firefox

1. `about:debugging#/runtime/this-firefox`
2. Find extension → Click "Inspect"

### Common Issues

| Problem            | Solution                                                  |
| ------------------ | --------------------------------------------------------- |
| Rules not applying | Check `chrome.declarativeNetRequest.getEnabledRulesets()` |
| Toggle not working | Verify `RULESET_ID` matches "ruleset_1"                   |
| Redirect loops     | Ensure allowlist priority >= redirect priority            |
| Regex not matching | Test at regex101.com (ECMAScript flavor)                  |

---

## CI/CD

GitHub Actions (`.github/workflows/ci.yml`):

1. **Validate**: JSON/JS syntax, ESLint, Prettier
2. **Build**: Create zip, verify contents, upload artifact

---

## File Structure

```
├── manifest.json          # Extension manifest (V3)
├── rules.json             # Redirect rules
├── background.js          # Service worker
├── storage.js             # Storage layer
├── logger.js              # Logging utility
├── content-script.js      # Page injection
├── styles.css             # Injected CSS
├── popup.html/js/css      # Popup UI
├── options.html/js/css    # Options page
├── onboarding.html/js/css # First-run UX
├── suggestions.js         # Subreddit suggestions
├── offscreen.html/js      # Clipboard access (MV3)
├── keyboard-utils.js      # Keyboard utilities
├── img/                   # Icons (16-128px)
├── tests/                 # Test suites
├── scripts/               # Build scripts
├── store/                 # Store metadata
└── docs/                  # Documentation
```
